<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>AR.js Marker Trigger HUD Video (FINAL FIX)</title>

  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

  <style>
    body { margin: 0; overflow: hidden; }
  </style>
</head>

<body>

<a-scene
  embedded
  arjs="sourceType: webcam; debugUIEnabled: false;"
  renderer="antialias: false; precision: low;"
>

  <!-- Marker ONLY as trigger -->
  <a-marker
    id="triggerMarker"
    type="pattern"
    url="pattern-qr.patt"
    emitevents="true"
  ></a-marker>

  <!-- Camera -->
  <a-entity camera>

    <!-- HUD VIDEO (NO SRC INITIALLY) -->
    <a-video
      id="videoHUD"
      width="3.2"
      height="1.8"
      position="0 0 -2"
      visible="false"
      muted
      playsinline
      webkit-playsinline
    ></a-video>

  </a-entity>

</a-scene>

<!-- Video element (NO autoplay) -->
<video
  id="vid"
  src="video.mp4"
  loop
  muted
  playsinline
  webkit-playsinline
  preload="auto"
></video>

<script>
window.addEventListener("DOMContentLoaded", () => {

  const marker = document.querySelector("#triggerMarker");
  const videoEntity = document.querySelector("#videoHUD");
  const videoEl = document.querySelector("#vid");
  const scene = document.querySelector("a-scene");

  let activated = false;

  marker.addEventListener("markerFound", () => {
    if (activated) return;
    activated = true;

    // 1️⃣ Bind video texture ONLY now (prevents flash)
    videoEntity.setAttribute("src", "#vid");

    // 2️⃣ Make it visible
    videoEntity.setAttribute("visible", true);

    // 3️⃣ Play on next frame (reliable on Android)
    requestAnimationFrame(async () => {
      try {
        await videoEl.play();
      } catch (e) {
        console.warn("Playback blocked, waiting for user interaction");
      }
    });

    // 4️⃣ Disable marker tracking (performance)
    scene.setAttribute("arjs", "trackingMethod: none;");
    marker.parentNode.removeChild(marker);
  });

});
</script>

</body>
</html>